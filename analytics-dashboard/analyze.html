<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyze - Analytics Dashboard</title>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/charts.css">

    <!-- Data Grid specific styles -->
    <style>
        .data-grid-container {
            background: var(--white);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            margin: var(--space-xl) 0;
            overflow: hidden;
        }

        .grid-header {
            background: var(--primary-navy);
            color: var(--white);
            padding: var(--space-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-md);
        }

        .grid-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .grid-actions {
            display: flex;
            gap: var(--space-sm);
            align-items: center;
        }

        .filter-panel {
            background: var(--light-gray);
            padding: var(--space-md);
            border-bottom: 1px solid var(--medium-gray);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: var(--space-xs);
        }

        .filter-group label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--dark-gray);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .data-grid {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .data-grid th {
            background: var(--near-white);
            padding: var(--space-md);
            text-align: left;
            font-weight: 600;
            color: var(--primary-navy);
            border-bottom: 2px solid var(--light-gray);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.75rem;
            position: sticky;
            top: 0;
            z-index: 100;
            cursor: pointer;
            transition: background-color var(--transition-fast);
        }

        .data-grid th:hover {
            background: var(--light-gray);
        }

        .data-grid th.sortable::after {
            content: ' â†•';
            opacity: 0.5;
            margin-left: var(--space-xs);
        }

        .data-grid th.sort-asc::after {
            content: ' â†‘';
            opacity: 1;
            color: var(--primary-blue);
        }

        .data-grid th.sort-desc::after {
            content: ' â†“';
            opacity: 1;
            color: var(--primary-blue);
        }

        .data-grid td {
            padding: var(--space-md);
            border-bottom: 1px solid var(--light-gray);
            vertical-align: middle;
        }

        .data-grid tr:hover {
            background: var(--near-white);
        }

        .data-grid tr.row-danger {
            background: rgba(231, 76, 60, 0.05);
            border-left: 4px solid var(--danger-red);
        }

        .data-grid tr.row-warning {
            background: rgba(243, 156, 18, 0.05);
            border-left: 4px solid var(--warning-amber);
        }

        .data-grid tr.row-success {
            background: rgba(39, 174, 96, 0.05);
            border-left: 4px solid var(--success-green);
        }

        .promotion-name {
            font-weight: 500;
            color: var(--primary-navy);
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .score-cell {
            font-weight: 700;
            font-variant-numeric: tabular-nums;
            text-align: center;
        }

        .score-high {
            color: var(--success-green);
        }

        .score-medium {
            color: var(--warning-amber);
        }

        .score-low {
            color: var(--danger-red);
        }

        .category-badge {
            background: var(--primary-blue);
            color: var(--white);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .size-badge {
            background: var(--medium-gray);
            color: var(--white);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            font-family: var(--font-mono);
        }

        .position-cell {
            font-size: 0.75rem;
            color: var(--medium-gray);
            text-transform: capitalize;
        }

        .actions-cell {
            text-align: center;
        }

        .view-btn {
            background: var(--primary-blue);
            color: var(--white);
            border: none;
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            cursor: pointer;
            transition: background-color var(--transition-fast);
        }

        .view-btn:hover {
            background: var(--primary-navy);
        }

        .grid-footer {
            background: var(--light-gray);
            padding: var(--space-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-md);
        }

        .pagination {
            display: flex;
            gap: var(--space-sm);
            align-items: center;
        }

        .pagination button {
            background: var(--white);
            border: 1px solid var(--medium-gray);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .pagination button:hover:not(:disabled) {
            background: var(--primary-blue);
            color: var(--white);
            border-color: var(--primary-blue);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button.active {
            background: var(--primary-blue);
            color: var(--white);
            border-color: var(--primary-blue);
        }

        .export-controls {
            display: flex;
            gap: var(--space-sm);
        }

        .stats-summary {
            display: flex;
            gap: var(--space-md);
            color: var(--medium-gray);
            font-size: 0.875rem;
        }

        .breadcrumb {
            background: var(--light-gray);
            padding: var(--space-md) var(--space-md);
            font-size: 0.875rem;
            border-bottom: 1px solid var(--medium-gray);
        }

        .breadcrumb a {
            color: var(--primary-blue);
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .breadcrumb-separator {
            margin: 0 var(--space-sm);
            color: var(--medium-gray);
        }

        @media (max-width: 768px) {
            .grid-header {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-panel {
                grid-template-columns: 1fr;
            }

            .data-grid th,
            .data-grid td {
                padding: var(--space-sm);
            }

            .promotion-name {
                max-width: 200px;
            }

            .grid-footer {
                flex-direction: column;
                align-items: stretch;
            }

            .stats-summary {
                justify-content: center;
            }

            .pagination {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Context Bar (Fixed Header) -->
    <header class="context-bar">
        <div class="header-top">
            <div class="viewing-context">
                <label for="viewingScope">Viewing:</label>
                <select id="viewingScope">
                    <option value="all_stores">All Stores</option>
                    <option value="northeast">Northeast Region</option>
                    <option value="southeast">Southeast Region</option>
                    <option value="store_123">Store #123 - Miami Lakes</option>
                </select>
            </div>
            <div class="time-context">
                <label for="timePeriod">Period:</label>
                <select id="timePeriod">
                    <option value="w36">Week 36: Sep 18-24, 2025</option>
                    <option value="w35">Week 35: Sep 11-17, 2025</option>
                    <option value="w34">Week 34: Sep 4-10, 2025</option>
                    <option value="ytd">Year to Date</option>
                </select>
            </div>
        </div>

        <!-- Main Navigation -->
        <nav class="main-nav">
            <ul class="nav-list">
                <li><a href="index.html" class="nav-item">Overview</a></li>
                <li><a href="explore.html" class="nav-item">Explore</a></li>
                <li><a href="analyze.html" class="nav-item active">Analyze</a></li>
                <li><a href="reports.html" class="nav-item">Reports</a></li>
            </ul>
        </nav>
    </header>

    <!-- Main Content Wrapper (below fixed header) -->
    <div class="main-content">
        <!-- Main Content Container -->
        <div class="container">
        <!-- Breadcrumb Navigation -->
        <div class="breadcrumb">
            <a href="index.html">Overview</a>
            <span class="breadcrumb-separator">â€º</span>
            <span>Analyze</span>
            <span id="breadcrumb-filter"></span>
        </div>

        <!-- Data Grid Container -->
        <div class="data-grid-container">
            <!-- Grid Header -->
            <div class="grid-header">
                <h1 class="grid-title">Promotion Analysis</h1>
                <div class="grid-actions">
                    <select id="viewMode" class="btn btn-secondary">
                        <option value="all">All Promotions</option>
                        <option value="top">Top Performers</option>
                        <option value="bottom">Bottom Performers</option>
                        <option value="alerts">Underperforming</option>
                    </select>
                    <button id="refreshData" class="btn btn-primary">Refresh</button>
                </div>
            </div>

            <!-- Filter Panel -->
            <div class="filter-panel">
                <div class="filter-group">
                    <label for="categoryFilter">Category</label>
                    <select id="categoryFilter">
                        <option value="">All Categories</option>
                        <!-- Will be populated by JavaScript -->
                    </select>
                </div>
                <div class="filter-group">
                    <label for="sizeFilter">Card Size</label>
                    <select id="sizeFilter">
                        <option value="">All Sizes</option>
                        <option value="1X1">1X1</option>
                        <option value="2X1">2X1</option>
                        <option value="1X2">1X2</option>
                        <option value="2X2">2X2</option>
                        <option value="3X1">3X1</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="positionFilter">Position</label>
                    <select id="positionFilter">
                        <option value="">All Positions</option>
                        <option value="top-left">Top Left</option>
                        <option value="top-center">Top Center</option>
                        <option value="top-right">Top Right</option>
                        <option value="mid-left">Mid Left</option>
                        <option value="mid-center">Mid Center</option>
                        <option value="mid-right">Mid Right</option>
                        <option value="bot-left">Bottom Left</option>
                        <option value="bot-center">Bottom Center</option>
                        <option value="bot-right">Bottom Right</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="scoreFilter">Score Range</label>
                    <select id="scoreFilter">
                        <option value="">All Scores</option>
                        <option value="high">High (80-100)</option>
                        <option value="medium">Medium (40-79)</option>
                        <option value="low">Low (0-39)</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="dealTypeFilter">Deal Type</label>
                    <select id="dealTypeFilter">
                        <option value="">All Deal Types</option>
                        <option value="fixed_price">Fixed Price</option>
                        <option value="percent_off">Percent Off</option>
                        <option value="bogo">BOGO</option>
                        <option value="buy_x_get_y">Buy X Get Y</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="searchFilter">Search</label>
                    <input type="text" id="searchFilter" placeholder="Search promotions...">
                </div>
            </div>

            <!-- Data Grid -->
            <div class="table-container" style="overflow-x: auto; max-height: 600px; overflow-y: auto;">
                <table class="data-grid" id="promotionsGrid">
                    <thead>
                        <tr>
                            <th class="sortable" data-sort="card_name">Promotion</th>
                            <th class="sortable" data-sort="category">Category</th>
                            <th class="sortable" data-sort="card_size">Size</th>
                            <th class="sortable" data-sort="position">Position</th>
                            <th class="sortable" data-sort="card_price">Price</th>
                            <th class="sortable" data-sort="composite_score">Score</th>
                            <th class="sortable" data-sort="percentile">Percentile</th>
                            <th class="sortable" data-sort="card_in_view">Views</th>
                            <th class="sortable" data-sort="added_to_list">ATL</th>
                            <th class="sortable" data-sort="share_count">Shares</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="gridBody">
                        <!-- Content will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <!-- Grid Footer -->
            <div class="grid-footer">
                <div class="stats-summary">
                    <span id="totalItems">Total: 0 items</span>
                    <span id="avgScore">Avg Score: 0</span>
                    <span id="medianScore">Median: 0</span>
                </div>
                <div class="pagination" id="pagination">
                    <!-- Pagination will be populated by JavaScript -->
                </div>
                <div class="export-controls">
                    <button class="btn btn-secondary" onclick="exportData('csv')">Export CSV</button>
                    <button class="btn btn-secondary" onclick="exportData('print')">Print</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal (for promotion details) -->
    <div id="detailModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center; padding: var(--space-md);">
        <div style="background: var(--white); border-radius: var(--radius-lg); max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto;">
            <div style="padding: var(--space-md); border-bottom: 1px solid var(--light-gray); display: flex; justify-content: space-between; align-items: center;">
                <h3 id="modalTitle">Promotion Details</h3>
                <button onclick="closeModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--medium-gray);">&times;</button>
            </div>
            <div id="modalContent" style="padding: var(--space-md);">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>
    </div>

    <!-- Scripts -->
    <script src="js/mock-data/sedanos-data.js"></script>
    <script src="js/components/data-grid.js"></script>
    <script src="js/app.js"></script>

    <script>
        // Initialize analyze page when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ðŸ“Š Initializing Analyze page...');

            // Initialize data grid
            const grid = new DataGrid('promotionsGrid', mockDatabase.promotions);

            // Apply filters from URL if present
            grid.applyFiltersFromURL();

            // Set up event listeners for filters
            setupFilterEvents(grid);

            // Update breadcrumb based on URL parameters
            updateBreadcrumb();

            console.log('âœ… Analyze page initialized');
        });

        function setupFilterEvents(grid) {
            // Filter event listeners
            const filters = ['categoryFilter', 'sizeFilter', 'positionFilter', 'scoreFilter', 'dealTypeFilter'];

            filters.forEach(filterId => {
                const filterElement = document.getElementById(filterId);
                if (filterElement) {
                    filterElement.addEventListener('change', () => {
                        grid.applyFilters();
                    });
                }
            });

            // Search filter with debouncing
            const searchFilter = document.getElementById('searchFilter');
            if (searchFilter) {
                let searchTimeout;
                searchFilter.addEventListener('input', () => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        grid.applyFilters();
                    }, 300);
                });
            }

            // View mode change
            const viewMode = document.getElementById('viewMode');
            if (viewMode) {
                viewMode.addEventListener('change', (e) => {
                    grid.setViewMode(e.target.value);
                });
            }

            // Refresh button
            const refreshBtn = document.getElementById('refreshData');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    grid.refresh();
                });
            }
        }

        function updateBreadcrumb() {
            const params = new URLSearchParams(window.location.search);
            const filter = params.get('filter');
            const breadcrumbFilter = document.getElementById('breadcrumb-filter');

            if (filter && breadcrumbFilter) {
                const filterNames = {
                    'week-performance': 'Week Performance',
                    'categories': 'Categories',
                    'underperforming': 'Underperforming',
                    'trends': 'Trends',
                    'optimization': 'Optimization',
                    'sharing': 'Sharing'
                };

                const filterName = filterNames[filter] || filter;
                breadcrumbFilter.innerHTML = `<span class="breadcrumb-separator">â€º</span><span>${filterName}</span>`;
            }
        }

        function viewDetails(cardId) {
            const promotion = mockDatabase.promotions.find(p => p.card_id === cardId);
            if (!promotion) return;

            const modal = document.getElementById('detailModal');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');

            title.textContent = promotion.card_name;

            content.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-md);">
                    <div>
                        <h4>Basic Information</h4>
                        <p><strong>Card ID:</strong> ${promotion.card_id}</p>
                        <p><strong>Category:</strong> ${promotion.category}</p>
                        <p><strong>Price:</strong> ${promotion.card_price}</p>
                        <p><strong>Deal Type:</strong> ${promotion.deal_type}</p>
                        <p><strong>Media Freshness:</strong> ${promotion.media_freshness}</p>
                    </div>
                    <div>
                        <h4>Layout Information</h4>
                        <p><strong>Size:</strong> ${promotion.card_size}</p>
                        <p><strong>Position:</strong> ${promotion.position}</p>
                        <p><strong>Quartile:</strong> ${promotion.quartile}</p>
                    </div>
                    <div>
                        <h4>Performance Metrics</h4>
                        <p><strong>Composite Score:</strong> <span class="score-cell ${getScoreClass(promotion.composite_score)}">${promotion.composite_score}</span></p>
                        <p><strong>Percentile:</strong> ${promotion.percentile}%</p>
                        <p><strong>Views:</strong> ${promotion.card_in_view.toLocaleString()}</p>
                        <p><strong>Clicks:</strong> ${promotion.card_clicked.toLocaleString()}</p>
                        <p><strong>Add to List:</strong> ${promotion.added_to_list.toLocaleString()}</p>
                    </div>
                    <div>
                        <h4>Engagement Details</h4>
                        <p><strong>Shares:</strong> ${promotion.share_count}</p>
                        <p><strong>Print Count:</strong> ${promotion.print_count}</p>
                        <p><strong>PDF Downloads:</strong> ${promotion.pdf_downloads}</p>
                        <p><strong>Click Rate:</strong> ${(promotion.card_clicked / promotion.card_in_view * 100).toFixed(1)}%</p>
                        <p><strong>ATL Rate:</strong> ${(promotion.added_to_list / promotion.card_clicked * 100).toFixed(1)}%</p>
                    </div>
                </div>
            `;

            modal.classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('detailModal').classList.add('hidden');
        }

        function getScoreClass(score) {
            if (score >= 80) return 'score-high';
            if (score >= 40) return 'score-medium';
            return 'score-low';
        }

        function exportData(format) {
            const grid = window.currentGrid; // Assuming we store reference
            if (!grid) return;

            if (format === 'csv') {
                grid.exportToCSV();
            } else if (format === 'print') {
                window.print();
            }
        }

        // Close modal when clicking outside
        document.getElementById('detailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>