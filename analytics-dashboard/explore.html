<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Explore - Analytics Dashboard</title>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/responsive.css">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="assets/icons/favicon.ico">

    <!-- Preload critical resources -->
    <link rel="preload" href="js/mock-data/sedanos-data.js" as="script">
    <link rel="preload" href="js/components/data-grid.js" as="script">
</head>
<body>
    <!-- Context Bar (Fixed Header) -->
    <header class="context-bar">
        <div class="header-top">
            <div class="viewing-context">
                <label for="viewingScope">Viewing:</label>
                <select id="viewingScope">
                    <option value="all_stores">All Stores</option>
                    <option value="northeast">Northeast Region</option>
                    <option value="southeast">Southeast Region</option>
                    <option value="store_123">Store #123 - Miami Lakes</option>
                    <option value="store_456">Store #456 - Kendall</option>
                    <option value="store_789">Store #789 - Hialeah</option>
                </select>
            </div>
            <div class="time-context">
                <label for="timePeriod">Period:</label>
                <select id="timePeriod">
                    <option value="w36">Week 36: Sep 18-24, 2025 (Day 5 of 7)</option>
                    <option value="w35">Week 35: Sep 11-17, 2025</option>
                    <option value="w34">Week 34: Sep 4-10, 2025</option>
                    <option value="w33">Week 33: Aug 28-Sep 3, 2025</option>
                    <option value="last_month">Last Month</option>
                    <option value="ytd">Year to Date</option>
                </select>
            </div>
        </div>

        <!-- Main Navigation -->
        <nav class="main-nav">
            <ul class="nav-list">
                <li><a href="index.html" class="nav-item">Overview</a></li>
                <li><a href="explore.html" class="nav-item active">Explore</a></li>
                <li><a href="analyze.html" class="nav-item">Analyze</a></li>
                <li><a href="reports.html" class="nav-item">Reports</a></li>
            </ul>
        </nav>
    </header>

    <!-- Breadcrumb Navigation -->
    <nav class="breadcrumb-nav">
        <ol class="breadcrumb">
            <li><a href="index.html">Dashboard</a></li>
            <li class="active">Explore</li>
        </ol>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <h1>Explore Performance Data</h1>
        <p class="page-description">Drill down into detailed performance metrics with interactive visualizations and comparative analysis</p>
    </div>

    <!-- Main Content Container -->
    <div class="container">
        <!-- Exploration Tools -->
        <div class="exploration-panel">
            <div class="panel-header">
                <h2>Exploration Tools</h2>
                <p>Select dimensions and metrics to create custom views</p>
            </div>

            <div class="exploration-controls">
                <div class="dimension-selector">
                    <label for="primaryDimension">Primary Dimension:</label>
                    <select id="primaryDimension">
                        <option value="category">Category</option>
                        <option value="position">Position</option>
                        <option value="size">Card Size</option>
                        <option value="deal_type">Deal Type</option>
                        <option value="price_range">Price Range</option>
                    </select>
                </div>

                <div class="metric-selector">
                    <label for="primaryMetric">Primary Metric:</label>
                    <select id="primaryMetric">
                        <option value="composite_score">Composite Score</option>
                        <option value="card_in_view">Views</option>
                        <option value="card_clicks">Clicks</option>
                        <option value="card_saves">Saves</option>
                        <option value="card_shares">Shares</option>
                        <option value="conversion_rate">Conversion Rate</option>
                    </select>
                </div>

                <div class="comparison-toggle">
                    <label>
                        <input type="checkbox" id="enableComparison">
                        Enable Comparison
                    </label>
                </div>

                <div class="comparison-selector" style="display: none;">
                    <label for="comparisonPeriod">Compare to:</label>
                    <select id="comparisonPeriod">
                        <option value="previous_week">Previous Week</option>
                        <option value="previous_month">Previous Month</option>
                        <option value="same_week_last_year">Same Week Last Year</option>
                    </select>
                </div>

                <button type="button" class="update-view-btn">Update View</button>
            </div>
        </div>

        <!-- Visualization Grid -->
        <div class="visualization-grid">
            <!-- Primary Chart -->
            <div class="chart-panel primary-chart">
                <div class="chart-header">
                    <h3 id="chartTitle">Category Performance by Composite Score</h3>
                    <div class="chart-controls">
                        <button type="button" class="chart-type-btn active" data-type="bar">Bar</button>
                        <button type="button" class="chart-type-btn" data-type="line">Line</button>
                        <button type="button" class="chart-type-btn" data-type="pie">Pie</button>
                        <button type="button" class="chart-type-btn" data-type="scatter">Scatter</button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="primaryChart" width="800" height="400"></canvas>
                </div>
                <div class="chart-insights">
                    <div id="chartInsights">
                        <!-- Insights will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Secondary Metrics -->
            <div class="metrics-panel secondary-metrics">
                <div class="panel-header">
                    <h3>Related Metrics</h3>
                </div>
                <div class="secondary-metrics-grid">
                    <!-- Populated by JavaScript -->
                </div>
            </div>

            <!-- Performance Heatmap -->
            <div class="heatmap-panel">
                <div class="panel-header">
                    <h3>Performance Heatmap</h3>
                    <div class="heatmap-controls">
                        <select id="heatmapMetric">
                            <option value="composite_score">Composite Score</option>
                            <option value="engagement_rate">Engagement Rate</option>
                            <option value="conversion_rate">Conversion Rate</option>
                        </select>
                    </div>
                </div>
                <div class="heatmap-container">
                    <div id="performanceHeatmap">
                        <!-- Heatmap will be populated by JavaScript -->
                    </div>
                </div>
                <div class="heatmap-legend">
                    <span class="legend-label">Low</span>
                    <div class="legend-gradient"></div>
                    <span class="legend-label">High</span>
                </div>
            </div>

            <!-- Trend Analysis -->
            <div class="trend-panel">
                <div class="panel-header">
                    <h3>Trend Analysis</h3>
                    <div class="trend-controls">
                        <select id="trendPeriod">
                            <option value="daily">Daily (Last 7 days)</option>
                            <option value="weekly">Weekly (Last 8 weeks)</option>
                            <option value="monthly">Monthly (Last 6 months)</option>
                        </select>
                    </div>
                </div>
                <div class="trend-container">
                    <canvas id="trendChart" width="600" height="300"></canvas>
                </div>
            </div>

            <!-- Distribution Analysis -->
            <div class="distribution-panel">
                <div class="panel-header">
                    <h3>Score Distribution</h3>
                </div>
                <div class="distribution-container">
                    <canvas id="distributionChart" width="600" height="300"></canvas>
                </div>
                <div class="distribution-stats">
                    <div class="stat-item">
                        <label>Mean:</label>
                        <span id="meanScore">--</span>
                    </div>
                    <div class="stat-item">
                        <label>Median:</label>
                        <span id="medianScore">--</span>
                    </div>
                    <div class="stat-item">
                        <label>Std Dev:</label>
                        <span id="stdDevScore">--</span>
                    </div>
                </div>
            </div>

            <!-- Top Performers -->
            <div class="top-performers-panel">
                <div class="panel-header">
                    <h3>Top Performers</h3>
                    <select id="topPerformersMetric">
                        <option value="composite_score">By Score</option>
                        <option value="card_clicks">By Clicks</option>
                        <option value="card_saves">By Saves</option>
                        <option value="engagement_rate">By Engagement</option>
                    </select>
                </div>
                <div class="performers-list" id="topPerformersList">
                    <!-- Populated by JavaScript -->
                </div>
                <a href="analyze.html" class="view-all-link">View All in Data Grid â†’</a>
            </div>
        </div>

        <!-- Drill-down Modals -->
        <div class="drill-down-container">
            <!-- Category Drill-down Modal -->
            <div id="categoryDrillModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="categoryModalTitle">Category Deep Dive</h2>
                        <button type="button" class="modal-close">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="category-metrics">
                            <!-- Populated by JavaScript -->
                        </div>
                        <div class="category-promotions">
                            <h3>Promotions in this Category</h3>
                            <div id="categoryPromotionsGrid">
                                <!-- Data grid will be inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Position Drill-down Modal -->
            <div id="positionDrillModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="positionModalTitle">Position Analysis</h2>
                        <button type="button" class="modal-close">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="position-heatmap">
                            <canvas id="positionHeatmapChart" width="400" height="300"></canvas>
                        </div>
                        <div class="position-insights">
                            <div id="positionInsights">
                                <!-- Insights populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/mock-data/sedanos-data.js"></script>
    <script src="js/components/data-grid.js"></script>
    <script>
        /**
         * Explore Page Controller
         * Handles interactive data exploration and visualization
         */
        class ExploreController {
            constructor() {
                this.data = mockDatabase;
                this.currentDimension = 'category';
                this.currentMetric = 'composite_score';
                this.currentChartType = 'bar';
                this.enableComparison = false;

                this.init();
            }

            init() {
                this.setupEventListeners();
                this.renderInitialView();
                this.populateSecondaryMetrics();
                this.renderPerformanceHeatmap();
                this.renderTrendAnalysis();
                this.renderDistributionChart();
                this.renderTopPerformers();
            }

            setupEventListeners() {
                // Exploration controls
                document.getElementById('enableComparison').addEventListener('change', (e) => {
                    this.enableComparison = e.target.checked;
                    document.querySelector('.comparison-selector').style.display =
                        this.enableComparison ? 'block' : 'none';
                });

                document.querySelector('.update-view-btn').addEventListener('click', () => {
                    this.updateView();
                });

                // Chart type controls
                document.querySelectorAll('.chart-type-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.chart-type-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentChartType = e.target.dataset.type;
                        this.renderPrimaryChart();
                    });
                });

                // Heatmap metric selector
                document.getElementById('heatmapMetric').addEventListener('change', () => {
                    this.renderPerformanceHeatmap();
                });

                // Trend period selector
                document.getElementById('trendPeriod').addEventListener('change', () => {
                    this.renderTrendAnalysis();
                });

                // Top performers metric selector
                document.getElementById('topPerformersMetric').addEventListener('change', () => {
                    this.renderTopPerformers();
                });

                // Modal close handlers
                document.querySelectorAll('.modal-close').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.target.closest('.modal').style.display = 'none';
                    });
                });

                // Click outside modal to close
                window.addEventListener('click', (e) => {
                    if (e.target.classList.contains('modal')) {
                        e.target.style.display = 'none';
                    }
                });
            }

            updateView() {
                this.currentDimension = document.getElementById('primaryDimension').value;
                this.currentMetric = document.getElementById('primaryMetric').value;
                this.renderPrimaryChart();
                this.updateChartTitle();
                this.generateChartInsights();
            }

            renderInitialView() {
                this.renderPrimaryChart();
                this.updateChartTitle();
                this.generateChartInsights();
            }

            renderPrimaryChart() {
                const canvas = document.getElementById('primaryChart');
                const ctx = canvas.getContext('2d');

                // Clear canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);

                const data = this.aggregateData(this.currentDimension, this.currentMetric);

                switch (this.currentChartType) {
                    case 'bar':
                        this.renderBarChart(ctx, data, canvas.width, canvas.height);
                        break;
                    case 'line':
                        this.renderLineChart(ctx, data, canvas.width, canvas.height);
                        break;
                    case 'pie':
                        this.renderPieChart(ctx, data, canvas.width, canvas.height);
                        break;
                    case 'scatter':
                        this.renderScatterChart(ctx, data, canvas.width, canvas.height);
                        break;
                }
            }

            aggregateData(dimension, metric) {
                const aggregated = {};

                this.data.promotions.forEach(promo => {
                    const key = promo[dimension] || 'Unknown';
                    if (!aggregated[key]) {
                        aggregated[key] = { count: 0, total: 0, items: [] };
                    }
                    aggregated[key].count++;
                    aggregated[key].total += promo[metric] || 0;
                    aggregated[key].items.push(promo);
                });

                return Object.entries(aggregated).map(([key, data]) => ({
                    label: key,
                    value: data.total / data.count, // Average
                    count: data.count,
                    total: data.total,
                    items: data.items
                })).sort((a, b) => b.value - a.value);
            }

            renderBarChart(ctx, data, width, height) {
                const margin = { top: 20, right: 20, bottom: 60, left: 60 };
                const chartWidth = width - margin.left - margin.right;
                const chartHeight = height - margin.top - margin.bottom;

                const maxValue = Math.max(...data.map(d => d.value));
                const barWidth = chartWidth / data.length * 0.8;
                const barSpacing = chartWidth / data.length * 0.2;

                // Draw bars
                data.forEach((item, index) => {
                    const barHeight = (item.value / maxValue) * chartHeight;
                    const x = margin.left + index * (barWidth + barSpacing);
                    const y = margin.top + chartHeight - barHeight;

                    // Bar
                    ctx.fillStyle = this.getColorForValue(item.value, maxValue);
                    ctx.fillRect(x, y, barWidth, barHeight);

                    // Value label
                    ctx.fillStyle = '#333';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(Math.round(item.value), x + barWidth/2, y - 5);

                    // Category label
                    ctx.save();
                    ctx.translate(x + barWidth/2, height - margin.bottom + 20);
                    ctx.rotate(-Math.PI/4);
                    ctx.textAlign = 'right';
                    ctx.fillText(item.label, 0, 0);
                    ctx.restore();
                });

                // Draw axes
                this.drawAxes(ctx, margin, chartWidth, chartHeight, maxValue);
            }

            renderLineChart(ctx, data, width, height) {
                const margin = { top: 20, right: 20, bottom: 60, left: 60 };
                const chartWidth = width - margin.left - margin.right;
                const chartHeight = height - margin.top - margin.bottom;

                const maxValue = Math.max(...data.map(d => d.value));
                const stepX = chartWidth / (data.length - 1);

                ctx.strokeStyle = '#3498DB';
                ctx.lineWidth = 2;
                ctx.beginPath();

                data.forEach((item, index) => {
                    const x = margin.left + index * stepX;
                    const y = margin.top + chartHeight - (item.value / maxValue) * chartHeight;

                    if (index === 0) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }

                    // Data points
                    ctx.fillStyle = '#3498DB';
                    ctx.beginPath();
                    ctx.arc(x, y, 4, 0, 2 * Math.PI);
                    ctx.fill();
                });

                ctx.stroke();
                this.drawAxes(ctx, margin, chartWidth, chartHeight, maxValue);
            }

            renderPieChart(ctx, data, width, height) {
                const centerX = width / 2;
                const centerY = height / 2;
                const radius = Math.min(width, height) / 2 - 40;

                const total = data.reduce((sum, item) => sum + item.value, 0);
                let currentAngle = -Math.PI / 2;

                data.forEach((item, index) => {
                    const angle = (item.value / total) * 2 * Math.PI;

                    ctx.fillStyle = this.getColorForIndex(index);
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + angle);
                    ctx.closePath();
                    ctx.fill();

                    // Label
                    const labelAngle = currentAngle + angle / 2;
                    const labelX = centerX + Math.cos(labelAngle) * (radius + 20);
                    const labelY = centerY + Math.sin(labelAngle) * (radius + 20);

                    ctx.fillStyle = '#333';
                    ctx.font = '12px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText(item.label, labelX, labelY);

                    currentAngle += angle;
                });
            }

            renderScatterChart(ctx, data, width, height) {
                const margin = { top: 20, right: 20, bottom: 60, left: 60 };
                const chartWidth = width - margin.left - margin.right;
                const chartHeight = height - margin.top - margin.bottom;

                // For scatter, we'll use count vs value
                const maxValue = Math.max(...data.map(d => d.value));
                const maxCount = Math.max(...data.map(d => d.count));

                data.forEach(item => {
                    const x = margin.left + (item.count / maxCount) * chartWidth;
                    const y = margin.top + chartHeight - (item.value / maxValue) * chartHeight;

                    ctx.fillStyle = this.getColorForValue(item.value, maxValue);
                    ctx.beginPath();
                    ctx.arc(x, y, Math.sqrt(item.count) * 2, 0, 2 * Math.PI);
                    ctx.fill();
                });

                this.drawAxes(ctx, margin, chartWidth, chartHeight, maxValue);
            }

            drawAxes(ctx, margin, chartWidth, chartHeight, maxValue) {
                ctx.strokeStyle = '#ddd';
                ctx.lineWidth = 1;

                // Y-axis
                ctx.beginPath();
                ctx.moveTo(margin.left, margin.top);
                ctx.lineTo(margin.left, margin.top + chartHeight);
                ctx.stroke();

                // X-axis
                ctx.beginPath();
                ctx.moveTo(margin.left, margin.top + chartHeight);
                ctx.lineTo(margin.left + chartWidth, margin.top + chartHeight);
                ctx.stroke();

                // Y-axis labels
                ctx.fillStyle = '#666';
                ctx.font = '10px Arial';
                ctx.textAlign = 'right';
                for (let i = 0; i <= 5; i++) {
                    const value = (maxValue / 5) * i;
                    const y = margin.top + chartHeight - (i / 5) * chartHeight;
                    ctx.fillText(Math.round(value), margin.left - 10, y + 3);
                }
            }

            getColorForValue(value, maxValue) {
                const ratio = value / maxValue;
                if (ratio > 0.8) return '#27AE60';
                if (ratio > 0.6) return '#F39C12';
                if (ratio > 0.4) return '#E67E22';
                return '#E74C3C';
            }

            getColorForIndex(index) {
                const colors = ['#3498DB', '#E74C3C', '#27AE60', '#F39C12', '#9B59B6', '#1ABC9C', '#34495E'];
                return colors[index % colors.length];
            }

            updateChartTitle() {
                const dimensionText = document.getElementById('primaryDimension').selectedOptions[0].text;
                const metricText = document.getElementById('primaryMetric').selectedOptions[0].text;
                document.getElementById('chartTitle').textContent = `${dimensionText} Performance by ${metricText}`;
            }

            generateChartInsights() {
                const data = this.aggregateData(this.currentDimension, this.currentMetric);
                const insights = [];

                if (data.length > 0) {
                    const best = data[0];
                    const worst = data[data.length - 1];
                    const average = data.reduce((sum, item) => sum + item.value, 0) / data.length;

                    insights.push(`<strong>Top performer:</strong> ${best.label} (${Math.round(best.value)})`);
                    insights.push(`<strong>Needs attention:</strong> ${worst.label} (${Math.round(worst.value)})`);
                    insights.push(`<strong>Average performance:</strong> ${Math.round(average)}`);

                    const aboveAverage = data.filter(item => item.value > average).length;
                    insights.push(`<strong>Above average:</strong> ${aboveAverage} of ${data.length} items`);
                }

                document.getElementById('chartInsights').innerHTML = insights.join('<br>');
            }

            populateSecondaryMetrics() {
                const metrics = [
                    { key: 'total_promotions', label: 'Total Promotions', value: this.data.promotions.length },
                    { key: 'avg_score', label: 'Avg Score', value: Math.round(this.data.promotions.reduce((sum, p) => sum + p.composite_score, 0) / this.data.promotions.length) },
                    { key: 'total_views', label: 'Total Views', value: this.data.promotions.reduce((sum, p) => sum + p.card_in_view, 0).toLocaleString() },
                    { key: 'total_clicks', label: 'Total Clicks', value: this.data.promotions.reduce((sum, p) => sum + p.card_clicks, 0).toLocaleString() }
                ];

                const container = document.querySelector('.secondary-metrics-grid');
                container.innerHTML = metrics.map(metric => `
                    <div class="metric-card">
                        <div class="metric-value">${metric.value}</div>
                        <div class="metric-label">${metric.label}</div>
                    </div>
                `).join('');
            }

            renderPerformanceHeatmap() {
                const metric = document.getElementById('heatmapMetric').value;
                const container = document.getElementById('performanceHeatmap');

                // Create position grid
                const positions = ['top-left', 'top-center', 'top-right', 'center-left', 'center', 'center-right', 'bottom-left', 'bottom-center', 'bottom-right'];
                const positionData = {};

                positions.forEach(pos => {
                    const promos = this.data.promotions.filter(p => p.position === pos);
                    if (promos.length > 0) {
                        positionData[pos] = promos.reduce((sum, p) => sum + (p[metric] || 0), 0) / promos.length;
                    } else {
                        positionData[pos] = 0;
                    }
                });

                const maxValue = Math.max(...Object.values(positionData));

                container.innerHTML = `
                    <div class="heatmap-grid">
                        ${positions.map(pos => {
                            const value = positionData[pos];
                            const intensity = value / maxValue;
                            const color = this.getHeatmapColor(intensity);
                            return `
                                <div class="heat-cell" style="background-color: ${color}"
                                     title="${pos}: ${Math.round(value)}"
                                     data-position="${pos}">
                                    <div class="cell-label">${pos.replace('-', ' ')}</div>
                                    <div class="cell-value">${Math.round(value)}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;

                // Add click handlers for drill-down
                container.querySelectorAll('.heat-cell').forEach(cell => {
                    cell.addEventListener('click', (e) => {
                        const position = e.currentTarget.dataset.position;
                        this.showPositionDrillDown(position);
                    });
                });
            }

            getHeatmapColor(intensity) {
                const r = Math.round(255 * (1 - intensity));
                const g = Math.round(255 * intensity);
                return `rgb(${r}, ${g}, 100)`;
            }

            renderTrendAnalysis() {
                const period = document.getElementById('trendPeriod').value;
                const canvas = document.getElementById('trendChart');
                const ctx = canvas.getContext('2d');

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // Generate trend data based on period
                const trendData = this.generateTrendData(period);
                this.renderLineChart(ctx, trendData, canvas.width, canvas.height);
            }

            generateTrendData(period) {
                // Simulate trend data
                const data = [];
                let points = 7;
                let baseValue = 75;

                switch (period) {
                    case 'daily':
                        points = 7;
                        break;
                    case 'weekly':
                        points = 8;
                        break;
                    case 'monthly':
                        points = 6;
                        break;
                }

                for (let i = 0; i < points; i++) {
                    const variance = (Math.random() - 0.5) * 20;
                    data.push({
                        label: `Period ${i + 1}`,
                        value: Math.max(0, baseValue + variance),
                        count: 1
                    });
                    baseValue += (Math.random() - 0.5) * 5; // Slight trend
                }

                return data;
            }

            renderDistributionChart() {
                const canvas = document.getElementById('distributionChart');
                const ctx = canvas.getContext('2d');

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                const scores = this.data.promotions.map(p => p.composite_score);
                const bins = this.createHistogramBins(scores, 10);

                this.renderBarChart(ctx, bins, canvas.width, canvas.height);

                // Update statistics
                const mean = scores.reduce((sum, score) => sum + score, 0) / scores.length;
                const median = this.calculateMedian(scores);
                const stdDev = this.calculateStandardDeviation(scores, mean);

                document.getElementById('meanScore').textContent = Math.round(mean);
                document.getElementById('medianScore').textContent = Math.round(median);
                document.getElementById('stdDevScore').textContent = Math.round(stdDev);
            }

            createHistogramBins(data, binCount) {
                const min = Math.min(...data);
                const max = Math.max(...data);
                const binSize = (max - min) / binCount;
                const bins = [];

                for (let i = 0; i < binCount; i++) {
                    const binStart = min + i * binSize;
                    const binEnd = min + (i + 1) * binSize;
                    const count = data.filter(value => value >= binStart && value < binEnd).length;

                    bins.push({
                        label: `${Math.round(binStart)}-${Math.round(binEnd)}`,
                        value: count,
                        count: count
                    });
                }

                return bins;
            }

            calculateMedian(data) {
                const sorted = [...data].sort((a, b) => a - b);
                const mid = Math.floor(sorted.length / 2);
                return sorted.length % 2 === 0 ? (sorted[mid - 1] + sorted[mid]) / 2 : sorted[mid];
            }

            calculateStandardDeviation(data, mean) {
                const variance = data.reduce((sum, value) => sum + Math.pow(value - mean, 2), 0) / data.length;
                return Math.sqrt(variance);
            }

            renderTopPerformers() {
                const metric = document.getElementById('topPerformersMetric').value;
                const sorted = [...this.data.promotions]
                    .sort((a, b) => (b[metric] || 0) - (a[metric] || 0))
                    .slice(0, 10);

                const container = document.getElementById('topPerformersList');
                container.innerHTML = sorted.map((promo, index) => `
                    <div class="performer-item" data-id="${promo.card_id}">
                        <div class="performer-rank">${index + 1}</div>
                        <div class="performer-info">
                            <div class="performer-name">${promo.card_name}</div>
                            <div class="performer-category">${promo.category}</div>
                        </div>
                        <div class="performer-value">${Math.round(promo[metric] || 0)}</div>
                    </div>
                `).join('');

                // Add click handlers
                container.querySelectorAll('.performer-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        const promoId = e.currentTarget.dataset.id;
                        this.showPromotionDetail(promoId);
                    });
                });
            }

            showPositionDrillDown(position) {
                const modal = document.getElementById('positionDrillModal');
                const title = document.getElementById('positionModalTitle');

                title.textContent = `Position Analysis: ${position}`;
                modal.style.display = 'block';

                // Render position-specific insights
                const positionPromos = this.data.promotions.filter(p => p.position === position);
                const insights = this.generatePositionInsights(position, positionPromos);

                document.getElementById('positionInsights').innerHTML = insights;
            }

            generatePositionInsights(position, promotions) {
                if (promotions.length === 0) {
                    return '<p>No promotions found for this position.</p>';
                }

                const avgScore = promotions.reduce((sum, p) => sum + p.composite_score, 0) / promotions.length;
                const avgClicks = promotions.reduce((sum, p) => sum + p.card_clicks, 0) / promotions.length;
                const topCategory = this.getMostFrequent(promotions.map(p => p.category));

                return `
                    <div class="position-stats">
                        <div class="stat-item">
                            <label>Promotions:</label>
                            <span>${promotions.length}</span>
                        </div>
                        <div class="stat-item">
                            <label>Avg Score:</label>
                            <span>${Math.round(avgScore)}</span>
                        </div>
                        <div class="stat-item">
                            <label>Avg Clicks:</label>
                            <span>${Math.round(avgClicks)}</span>
                        </div>
                        <div class="stat-item">
                            <label>Top Category:</label>
                            <span>${topCategory}</span>
                        </div>
                    </div>
                    <h4>Recommendations:</h4>
                    <ul>
                        <li>Consider placing high-performing categories in this position</li>
                        <li>Monitor click-through rates for optimization opportunities</li>
                        <li>Test different promotion types in this position</li>
                    </ul>
                `;
            }

            getMostFrequent(array) {
                const frequency = {};
                array.forEach(item => frequency[item] = (frequency[item] || 0) + 1);
                return Object.entries(frequency).reduce((a, b) => frequency[a] > frequency[b] ? a : b)[0];
            }

            showPromotionDetail(promoId) {
                // This would typically show a detailed modal
                // For now, navigate to analyze page with filter
                window.location.href = `analyze.html?promotion=${promoId}`;
            }
        }

        // Initialize the explore controller when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new ExploreController();
        });
    </script>
</body>
</html>