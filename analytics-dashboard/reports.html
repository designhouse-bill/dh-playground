<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Analytics Dashboard</title>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/responsive.css">

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="assets/icons/favicon.ico">

    <!-- Preload critical resources -->
    <link rel="preload" href="js/mock-data/sedanos-data.js" as="script">
</head>
<body>
    <!-- Context Bar (Fixed Header) -->
    <header class="context-bar">
        <div class="header-top">
            <div class="viewing-context">
                <label for="viewingScope">Viewing:</label>
                <select id="viewingScope">
                    <option value="all_stores">All Stores</option>
                    <option value="northeast">Northeast Region</option>
                    <option value="southeast">Southeast Region</option>
                    <option value="store_123">Store #123 - Miami Lakes</option>
                    <option value="store_456">Store #456 - Kendall</option>
                    <option value="store_789">Store #789 - Hialeah</option>
                </select>
            </div>
            <div class="time-context">
                <label for="timePeriod">Period:</label>
                <select id="timePeriod">
                    <option value="w36">Week 36: Sep 18-24, 2025 (Day 5 of 7)</option>
                    <option value="w35">Week 35: Sep 11-17, 2025</option>
                    <option value="w34">Week 34: Sep 4-10, 2025</option>
                    <option value="w33">Week 33: Aug 28-Sep 3, 2025</option>
                    <option value="last_month">Last Month</option>
                    <option value="ytd">Year to Date</option>
                </select>
            </div>
        </div>

        <!-- Main Navigation -->
        <nav class="main-nav">
            <ul class="nav-list">
                <li><a href="index.html" class="nav-item">Overview</a></li>
                <li><a href="explore.html" class="nav-item">Explore</a></li>
                <li><a href="analyze.html" class="nav-item">Analyze</a></li>
                <li><a href="reports.html" class="nav-item active">Reports</a></li>
            </ul>
        </nav>
    </header>

    <!-- Breadcrumb Navigation -->
    <nav class="breadcrumb-nav">
        <ol class="breadcrumb">
            <li><a href="index.html">Dashboard</a></li>
            <li class="active">Reports</li>
        </ol>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <h1>Reports & Analytics</h1>
        <p class="page-description">Generate comprehensive reports and export data for stakeholder analysis</p>
    </div>

    <!-- Main Content Container -->
    <div class="container">
        <!-- Report Builder -->
        <div class="report-builder-panel">
            <div class="panel-header">
                <h2>Report Builder</h2>
                <p>Create custom reports with your preferred metrics and visualizations</p>
            </div>

            <div class="report-config">
                <div class="config-section">
                    <h3>Report Configuration</h3>
                    <div class="config-grid">
                        <div class="config-item">
                            <label for="reportName">Report Name:</label>
                            <input type="text" id="reportName" placeholder="Weekly Performance Report" value="Weekly Performance Report">
                        </div>

                        <div class="config-item">
                            <label for="reportType">Report Type:</label>
                            <select id="reportType">
                                <option value="executive">Executive Summary</option>
                                <option value="detailed">Detailed Analysis</option>
                                <option value="comparative">Comparative Analysis</option>
                                <option value="performance">Performance Review</option>
                                <option value="custom">Custom Report</option>
                            </select>
                        </div>

                        <div class="config-item">
                            <label for="reportFormat">Export Format:</label>
                            <select id="reportFormat">
                                <option value="pdf">PDF Report</option>
                                <option value="excel">Excel Workbook</option>
                                <option value="powerpoint">PowerPoint Presentation</option>
                                <option value="csv">CSV Data</option>
                                <option value="json">JSON Data</option>
                            </select>
                        </div>

                        <div class="config-item">
                            <label for="includePeriod">Time Period:</label>
                            <select id="includePeriod">
                                <option value="current">Current Period Only</option>
                                <option value="last_4_weeks">Last 4 Weeks</option>
                                <option value="last_3_months">Last 3 Months</option>
                                <option value="ytd">Year to Date</option>
                                <option value="custom_range">Custom Date Range</option>
                            </select>
                        </div>
                    </div>

                    <div class="date-range-selector" style="display: none;">
                        <div class="date-inputs">
                            <div class="date-item">
                                <label for="startDate">Start Date:</label>
                                <input type="date" id="startDate">
                            </div>
                            <div class="date-item">
                                <label for="endDate">End Date:</label>
                                <input type="date" id="endDate">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="config-section">
                    <h3>Include Sections</h3>
                    <div class="sections-grid">
                        <label class="section-checkbox">
                            <input type="checkbox" name="sections" value="executive_summary" checked>
                            <span class="checkmark"></span>
                            Executive Summary
                        </label>

                        <label class="section-checkbox">
                            <input type="checkbox" name="sections" value="kpi_overview" checked>
                            <span class="checkmark"></span>
                            KPI Overview
                        </label>

                        <label class="section-checkbox">
                            <input type="checkbox" name="sections" value="category_performance" checked>
                            <span class="checkmark"></span>
                            Category Performance
                        </label>

                        <label class="section-checkbox">
                            <input type="checkbox" name="sections" value="position_analysis" checked>
                            <span class="checkmark"></span>
                            Position Analysis
                        </label>

                        <label class="section-checkbox">
                            <input type="checkbox" name="sections" value="trend_analysis">
                            <span class="checkmark"></span>
                            Trend Analysis
                        </label>

                        <label class="section-checkbox">
                            <input type="checkbox" name="sections" value="top_performers">
                            <span class="checkmark"></span>
                            Top Performers
                        </label>

                        <label class="section-checkbox">
                            <input type="checkbox" name="sections" value="recommendations">
                            <span class="checkmark"></span>
                            Recommendations
                        </label>

                        <label class="section-checkbox">
                            <input type="checkbox" name="sections" value="raw_data">
                            <span class="checkmark"></span>
                            Raw Data Tables
                        </label>
                    </div>
                </div>

                <div class="config-section">
                    <h3>Visualization Options</h3>
                    <div class="viz-options">
                        <label class="section-checkbox">
                            <input type="checkbox" name="visualizations" value="charts" checked>
                            <span class="checkmark"></span>
                            Include Charts & Graphs
                        </label>

                        <label class="section-checkbox">
                            <input type="checkbox" name="visualizations" value="heatmaps" checked>
                            <span class="checkmark"></span>
                            Position Heatmaps
                        </label>

                        <label class="section-checkbox">
                            <input type="checkbox" name="visualizations" value="tables">
                            <span class="checkmark"></span>
                            Data Tables
                        </label>

                        <label class="section-checkbox">
                            <input type="checkbox" name="visualizations" value="comparisons">
                            <span class="checkmark"></span>
                            Period Comparisons
                        </label>
                    </div>
                </div>

                <div class="report-actions">
                    <button type="button" class="preview-report-btn">Preview Report</button>
                    <button type="button" class="generate-report-btn">Generate Report</button>
                    <button type="button" class="save-template-btn">Save as Template</button>
                </div>
            </div>
        </div>

        <!-- Saved Reports -->
        <div class="saved-reports-panel">
            <div class="panel-header">
                <h2>Saved Reports & Templates</h2>
                <p>Access previously generated reports and saved templates</p>
            </div>

            <div class="reports-tabs">
                <button type="button" class="tab-btn active" data-tab="recent">Recent Reports</button>
                <button type="button" class="tab-btn" data-tab="templates">Templates</button>
                <button type="button" class="tab-btn" data-tab="scheduled">Scheduled</button>
            </div>

            <div class="tab-content">
                <!-- Recent Reports Tab -->
                <div class="tab-panel active" data-tab="recent">
                    <div class="reports-list" id="recentReportsList">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Templates Tab -->
                <div class="tab-panel" data-tab="templates">
                    <div class="templates-list" id="templatesList">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Scheduled Tab -->
                <div class="tab-panel" data-tab="scheduled">
                    <div class="scheduled-reports" id="scheduledReports">
                        <div class="schedule-new">
                            <h3>Schedule New Report</h3>
                            <form class="schedule-form">
                                <div class="form-row">
                                    <div class="form-item">
                                        <label for="scheduleTemplate">Template:</label>
                                        <select id="scheduleTemplate">
                                            <option value="">Select Template</option>
                                            <option value="weekly_executive">Weekly Executive Summary</option>
                                            <option value="monthly_detailed">Monthly Detailed Analysis</option>
                                            <option value="performance_review">Performance Review</option>
                                        </select>
                                    </div>

                                    <div class="form-item">
                                        <label for="scheduleFrequency">Frequency:</label>
                                        <select id="scheduleFrequency">
                                            <option value="weekly">Weekly</option>
                                            <option value="monthly">Monthly</option>
                                            <option value="quarterly">Quarterly</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-item">
                                        <label for="scheduleEmail">Email Recipients:</label>
                                        <input type="email" id="scheduleEmail" placeholder="emails@example.com" multiple>
                                    </div>

                                    <div class="form-item">
                                        <label for="scheduleDay">Delivery Day:</label>
                                        <select id="scheduleDay">
                                            <option value="monday">Monday</option>
                                            <option value="tuesday">Tuesday</option>
                                            <option value="wednesday">Wednesday</option>
                                            <option value="thursday">Thursday</option>
                                            <option value="friday">Friday</option>
                                        </select>
                                    </div>
                                </div>

                                <button type="submit" class="schedule-submit-btn">Schedule Report</button>
                            </form>
                        </div>

                        <div class="existing-schedules">
                            <h3>Existing Schedules</h3>
                            <div id="existingSchedulesList">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Export Panel -->
        <div class="quick-export-panel">
            <div class="panel-header">
                <h2>Quick Export</h2>
                <p>Fast export options for common data requests</p>
            </div>

            <div class="quick-export-grid">
                <div class="export-card" data-export="current_week">
                    <div class="export-icon">üìä</div>
                    <h3>Current Week Data</h3>
                    <p>All promotion data for the current week period</p>
                    <div class="export-options">
                        <button type="button" class="export-btn" data-format="csv">CSV</button>
                        <button type="button" class="export-btn" data-format="excel">Excel</button>
                        <button type="button" class="export-btn" data-format="json">JSON</button>
                    </div>
                </div>

                <div class="export-card" data-export="top_performers">
                    <div class="export-icon">üèÜ</div>
                    <h3>Top Performers</h3>
                    <p>Highest scoring promotions and categories</p>
                    <div class="export-options">
                        <button type="button" class="export-btn" data-format="pdf">PDF</button>
                        <button type="button" class="export-btn" data-format="excel">Excel</button>
                    </div>
                </div>

                <div class="export-card" data-export="category_summary">
                    <div class="export-icon">üìà</div>
                    <h3>Category Summary</h3>
                    <p>Performance summary by product category</p>
                    <div class="export-options">
                        <button type="button" class="export-btn" data-format="csv">CSV</button>
                        <button type="button" class="export-btn" data-format="powerpoint">PPT</button>
                    </div>
                </div>

                <div class="export-card" data-export="position_heatmap">
                    <div class="export-icon">üéØ</div>
                    <h3>Position Heatmap</h3>
                    <p>Visual representation of position performance</p>
                    <div class="export-options">
                        <button type="button" class="export-btn" data-format="pdf">PDF</button>
                        <button type="button" class="export-btn" data-format="png">PNG</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Report Preview Modal -->
        <div id="reportPreviewModal" class="modal" style="display: none;">
            <div class="modal-content report-preview">
                <div class="modal-header">
                    <h2>Report Preview</h2>
                    <button type="button" class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="preview-toolbar">
                        <button type="button" class="preview-btn" data-action="zoom-in">Zoom In</button>
                        <button type="button" class="preview-btn" data-action="zoom-out">Zoom Out</button>
                        <button type="button" class="preview-btn" data-action="fit-width">Fit Width</button>
                        <select id="previewPage">
                            <option value="1">Page 1</option>
                            <!-- Additional pages populated by JavaScript -->
                        </select>
                    </div>
                    <div class="preview-container">
                        <div id="reportPreviewContent">
                            <!-- Report preview content -->
                        </div>
                    </div>
                    <div class="preview-actions">
                        <button type="button" class="edit-report-btn">Edit Report</button>
                        <button type="button" class="download-report-btn">Download Report</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="js/mock-data/sedanos-data.js"></script>
    <script>
        /**
         * Reports Page Controller
         * Handles report generation, templates, and export functionality
         */
        class ReportsController {
            constructor() {
                this.data = mockDatabase;
                this.savedReports = this.loadSavedReports();
                this.templates = this.loadTemplates();
                this.scheduledReports = this.loadScheduledReports();
                this.currentReport = null;

                this.init();
            }

            init() {
                this.setupEventListeners();
                this.populateRecentReports();
                this.populateTemplates();
                this.populateScheduledReports();
                this.setupDateRange();
            }

            setupEventListeners() {
                // Report configuration
                document.getElementById('includePeriod').addEventListener('change', (e) => {
                    const dateRange = document.querySelector('.date-range-selector');
                    dateRange.style.display = e.target.value === 'custom_range' ? 'block' : 'none';
                });

                // Report actions
                document.querySelector('.preview-report-btn').addEventListener('click', () => {
                    this.previewReport();
                });

                document.querySelector('.generate-report-btn').addEventListener('click', () => {
                    this.generateReport();
                });

                document.querySelector('.save-template-btn').addEventListener('click', () => {
                    this.saveTemplate();
                });

                // Tabs
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const tabName = e.target.dataset.tab;
                        this.switchTab(tabName);
                    });
                });

                // Quick export
                document.querySelectorAll('.export-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const card = e.target.closest('.export-card');
                        const exportType = card.dataset.export;
                        const format = e.target.dataset.format;
                        this.quickExport(exportType, format);
                    });
                });

                // Schedule form
                document.querySelector('.schedule-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.scheduleReport();
                });

                // Modal close
                document.querySelectorAll('.modal-close').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.target.closest('.modal').style.display = 'none';
                    });
                });

                // Preview actions
                document.querySelector('.download-report-btn').addEventListener('click', () => {
                    this.downloadCurrentReport();
                });

                document.querySelector('.edit-report-btn').addEventListener('click', () => {
                    document.getElementById('reportPreviewModal').style.display = 'none';
                });
            }

            setupDateRange() {
                const today = new Date();
                const oneWeekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);

                document.getElementById('startDate').valueAsDate = oneWeekAgo;
                document.getElementById('endDate').valueAsDate = today;
            }

            previewReport() {
                const config = this.getReportConfig();
                this.currentReport = this.buildReport(config);

                const modal = document.getElementById('reportPreviewModal');
                const content = document.getElementById('reportPreviewContent');

                content.innerHTML = this.renderReportPreview(this.currentReport);
                modal.style.display = 'block';
            }

            generateReport() {
                const config = this.getReportConfig();
                const report = this.buildReport(config);
                this.downloadReport(report, config.format);
            }

            saveTemplate() {
                const config = this.getReportConfig();
                const templateName = prompt('Enter template name:');

                if (templateName) {
                    const template = {
                        id: 'template_' + Date.now(),
                        name: templateName,
                        config: config,
                        created: new Date().toISOString()
                    };

                    this.templates.push(template);
                    this.saveTemplates();
                    this.populateTemplates();
                    alert('Template saved successfully!');
                }
            }

            getReportConfig() {
                const sections = Array.from(document.querySelectorAll('input[name="sections"]:checked'))
                    .map(cb => cb.value);

                const visualizations = Array.from(document.querySelectorAll('input[name="visualizations"]:checked'))
                    .map(cb => cb.value);

                return {
                    name: document.getElementById('reportName').value,
                    type: document.getElementById('reportType').value,
                    format: document.getElementById('reportFormat').value,
                    period: document.getElementById('includePeriod').value,
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,
                    sections: sections,
                    visualizations: visualizations
                };
            }

            buildReport(config) {
                const report = {
                    config: config,
                    timestamp: new Date().toISOString(),
                    sections: {}
                };

                // Build each section based on configuration
                if (config.sections.includes('executive_summary')) {
                    report.sections.executive_summary = this.buildExecutiveSummary();
                }

                if (config.sections.includes('kpi_overview')) {
                    report.sections.kpi_overview = this.buildKPIOverview();
                }

                if (config.sections.includes('category_performance')) {
                    report.sections.category_performance = this.buildCategoryPerformance();
                }

                if (config.sections.includes('position_analysis')) {
                    report.sections.position_analysis = this.buildPositionAnalysis();
                }

                if (config.sections.includes('trend_analysis')) {
                    report.sections.trend_analysis = this.buildTrendAnalysis();
                }

                if (config.sections.includes('top_performers')) {
                    report.sections.top_performers = this.buildTopPerformers();
                }

                if (config.sections.includes('recommendations')) {
                    report.sections.recommendations = this.buildRecommendations();
                }

                if (config.sections.includes('raw_data')) {
                    report.sections.raw_data = this.buildRawDataTables();
                }

                return report;
            }

            buildExecutiveSummary() {
                const totalPromotions = this.data.promotions.length;
                const avgScore = this.calculateAverage(this.data.promotions, 'composite_score');
                const totalViews = this.calculateSum(this.data.promotions, 'card_in_view');
                const totalClicks = this.calculateSum(this.data.promotions, 'card_clicks');
                const clickRate = totalClicks / totalViews * 100;

                return {
                    title: 'Executive Summary',
                    metrics: {
                        totalPromotions,
                        avgScore: Math.round(avgScore),
                        totalViews,
                        totalClicks,
                        clickRate: Math.round(clickRate * 100) / 100
                    },
                    insights: [
                        `${totalPromotions} promotions analyzed with average performance score of ${Math.round(avgScore)}`,
                        `Total engagement: ${totalViews.toLocaleString()} views, ${totalClicks.toLocaleString()} clicks`,
                        `Overall click-through rate: ${Math.round(clickRate * 100) / 100}%`,
                        this.getTopInsight()
                    ]
                };
            }

            buildKPIOverview() {
                return {
                    title: 'KPI Overview',
                    kpis: [
                        {
                            name: 'Performance Score',
                            value: Math.round(this.calculateAverage(this.data.promotions, 'composite_score')),
                            target: 80,
                            status: 'on-track'
                        },
                        {
                            name: 'Engagement Rate',
                            value: Math.round(this.calculateAverage(this.data.promotions, 'engagement_rate')),
                            target: 15,
                            status: 'above-target'
                        },
                        {
                            name: 'Click-Through Rate',
                            value: Math.round(this.calculateSum(this.data.promotions, 'card_clicks') / this.calculateSum(this.data.promotions, 'card_in_view') * 100 * 100) / 100,
                            target: 5,
                            status: 'below-target'
                        }
                    ]
                };
            }

            buildCategoryPerformance() {
                const categoryStats = {};

                this.data.promotions.forEach(promo => {
                    const cat = promo.category;
                    if (!categoryStats[cat]) {
                        categoryStats[cat] = { count: 0, scoreSum: 0, viewSum: 0, clickSum: 0 };
                    }
                    categoryStats[cat].count++;
                    categoryStats[cat].scoreSum += promo.composite_score;
                    categoryStats[cat].viewSum += promo.card_in_view;
                    categoryStats[cat].clickSum += promo.card_clicks;
                });

                const categories = Object.entries(categoryStats).map(([name, stats]) => ({
                    name,
                    count: stats.count,
                    avgScore: Math.round(stats.scoreSum / stats.count),
                    totalViews: stats.viewSum,
                    totalClicks: stats.clickSum,
                    clickRate: Math.round(stats.clickSum / stats.viewSum * 100 * 100) / 100
                })).sort((a, b) => b.avgScore - a.avgScore);

                return {
                    title: 'Category Performance',
                    categories: categories
                };
            }

            buildPositionAnalysis() {
                const positionStats = {};

                this.data.promotions.forEach(promo => {
                    const pos = promo.position;
                    if (!positionStats[pos]) {
                        positionStats[pos] = { count: 0, scoreSum: 0, viewSum: 0, clickSum: 0 };
                    }
                    positionStats[pos].count++;
                    positionStats[pos].scoreSum += promo.composite_score;
                    positionStats[pos].viewSum += promo.card_in_view;
                    positionStats[pos].clickSum += promo.card_clicks;
                });

                const positions = Object.entries(positionStats).map(([name, stats]) => ({
                    name,
                    count: stats.count,
                    avgScore: Math.round(stats.scoreSum / stats.count),
                    totalViews: stats.viewSum,
                    totalClicks: stats.clickSum,
                    clickRate: Math.round(stats.clickSum / stats.viewSum * 100 * 100) / 100
                })).sort((a, b) => b.avgScore - a.avgScore);

                return {
                    title: 'Position Analysis',
                    positions: positions
                };
            }

            buildTrendAnalysis() {
                // Simulate trend data
                return {
                    title: 'Trend Analysis',
                    trends: [
                        { period: 'Week 33', score: 78, change: +2.5 },
                        { period: 'Week 34', score: 82, change: +5.1 },
                        { period: 'Week 35', score: 79, change: -3.7 },
                        { period: 'Week 36', score: 83, change: +5.1 }
                    ],
                    insights: [
                        'Performance has shown an upward trend over the last 4 weeks',
                        'Average weekly improvement of 2.75%',
                        'Strongest performance in Week 36 with 83 average score'
                    ]
                };
            }

            buildTopPerformers() {
                const topByScore = [...this.data.promotions]
                    .sort((a, b) => b.composite_score - a.composite_score)
                    .slice(0, 10);

                const topByClicks = [...this.data.promotions]
                    .sort((a, b) => b.card_clicks - a.card_clicks)
                    .slice(0, 10);

                return {
                    title: 'Top Performers',
                    byScore: topByScore,
                    byClicks: topByClicks
                };
            }

            buildRecommendations() {
                const avgScore = this.calculateAverage(this.data.promotions, 'composite_score');
                const lowPerformers = this.data.promotions.filter(p => p.composite_score < avgScore * 0.8);

                return {
                    title: 'Recommendations',
                    recommendations: [
                        {
                            priority: 'High',
                            title: 'Optimize Low-Performing Promotions',
                            description: `${lowPerformers.length} promotions are significantly underperforming`,
                            action: 'Review positioning and messaging for these promotions'
                        },
                        {
                            priority: 'Medium',
                            title: 'Expand Top-Performing Categories',
                            description: 'FEATURED and GROCERY categories show strongest performance',
                            action: 'Consider increasing allocation to these categories'
                        },
                        {
                            priority: 'Low',
                            title: 'Position Optimization',
                            description: 'Top positions show better engagement rates',
                            action: 'Test moving mid-performing content to premium positions'
                        }
                    ]
                };
            }

            buildRawDataTables() {
                return {
                    title: 'Raw Data',
                    promotions: this.data.promotions,
                    categories: this.data.categories,
                    summary: {
                        promotionCount: this.data.promotions.length,
                        categoryCount: this.data.categories.length,
                        avgScore: Math.round(this.calculateAverage(this.data.promotions, 'composite_score'))
                    }
                };
            }

            renderReportPreview(report) {
                let html = `
                    <div class="report-document">
                        <div class="report-header">
                            <h1>${report.config.name}</h1>
                            <div class="report-meta">
                                <span>Generated: ${new Date(report.timestamp).toLocaleString()}</span>
                                <span>Type: ${report.config.type}</span>
                            </div>
                        </div>
                `;

                Object.entries(report.sections).forEach(([sectionKey, section]) => {
                    html += this.renderReportSection(section);
                });

                html += '</div>';
                return html;
            }

            renderReportSection(section) {
                let html = `<div class="report-section">
                    <h2>${section.title}</h2>`;

                switch (section.title) {
                    case 'Executive Summary':
                        html += `
                            <div class="summary-metrics">
                                <div class="metric">
                                    <label>Total Promotions:</label>
                                    <value>${section.metrics.totalPromotions}</value>
                                </div>
                                <div class="metric">
                                    <label>Average Score:</label>
                                    <value>${section.metrics.avgScore}</value>
                                </div>
                                <div class="metric">
                                    <label>Click Rate:</label>
                                    <value>${section.metrics.clickRate}%</value>
                                </div>
                            </div>
                            <div class="insights">
                                <h3>Key Insights:</h3>
                                <ul>
                                    ${section.insights.map(insight => `<li>${insight}</li>`).join('')}
                                </ul>
                            </div>
                        `;
                        break;

                    case 'Category Performance':
                        html += `
                            <table class="report-table">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Count</th>
                                        <th>Avg Score</th>
                                        <th>Total Views</th>
                                        <th>Click Rate</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${section.categories.map(cat => `
                                        <tr>
                                            <td>${cat.name}</td>
                                            <td>${cat.count}</td>
                                            <td>${cat.avgScore}</td>
                                            <td>${cat.totalViews.toLocaleString()}</td>
                                            <td>${cat.clickRate}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        `;
                        break;

                    case 'Top Performers':
                        html += `
                            <div class="performers-grid">
                                <div class="performers-column">
                                    <h3>By Score</h3>
                                    <ol>
                                        ${section.byScore.slice(0, 5).map(promo => `
                                            <li>${promo.card_name} (${promo.composite_score})</li>
                                        `).join('')}
                                    </ol>
                                </div>
                                <div class="performers-column">
                                    <h3>By Clicks</h3>
                                    <ol>
                                        ${section.byClicks.slice(0, 5).map(promo => `
                                            <li>${promo.card_name} (${promo.card_clicks})</li>
                                        `).join('')}
                                    </ol>
                                </div>
                            </div>
                        `;
                        break;

                    case 'Recommendations':
                        html += `
                            <div class="recommendations-list">
                                ${section.recommendations.map(rec => `
                                    <div class="recommendation priority-${rec.priority.toLowerCase()}">
                                        <div class="rec-header">
                                            <span class="priority">${rec.priority} Priority</span>
                                            <h3>${rec.title}</h3>
                                        </div>
                                        <p>${rec.description}</p>
                                        <div class="action"><strong>Action:</strong> ${rec.action}</div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                        break;

                    default:
                        html += `<p>Section content for ${section.title}</p>`;
                }

                html += '</div>';
                return html;
            }

            downloadReport(report, format) {
                switch (format) {
                    case 'pdf':
                        this.downloadPDF(report);
                        break;
                    case 'excel':
                        this.downloadExcel(report);
                        break;
                    case 'csv':
                        this.downloadCSV(report);
                        break;
                    case 'json':
                        this.downloadJSON(report);
                        break;
                    case 'powerpoint':
                        this.downloadPowerPoint(report);
                        break;
                }

                // Save to recent reports
                this.savedReports.unshift({
                    id: 'report_' + Date.now(),
                    name: report.config.name,
                    format: format,
                    generated: report.timestamp,
                    config: report.config
                });

                this.saveSavedReports();
                this.populateRecentReports();
            }

            downloadPDF(report) {
                // In a real implementation, this would generate a proper PDF
                const content = this.renderReportPreview(report);
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${report.config.name}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            .report-header { border-bottom: 2px solid #333; padding-bottom: 20px; margin-bottom: 30px; }
                            .report-section { margin-bottom: 30px; }
                            .report-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                            .report-table th, .report-table td { padding: 8px; border: 1px solid #ddd; text-align: left; }
                            .report-table th { background-color: #f5f5f5; }
                            .summary-metrics { display: flex; gap: 20px; margin: 20px 0; }
                            .metric { padding: 10px; border: 1px solid #ddd; }
                            @media print { body { margin: 0; } }
                        </style>
                    </head>
                    <body>${content}</body>
                    </html>
                `);
                printWindow.document.close();
                setTimeout(() => printWindow.print(), 250);
            }

            downloadExcel(report) {
                // Simplified Excel export (CSV format)
                let csvContent = `${report.config.name}\nGenerated: ${new Date(report.timestamp).toLocaleString()}\n\n`;

                if (report.sections.category_performance) {
                    csvContent += "Category Performance\n";
                    csvContent += "Category,Count,Avg Score,Total Views,Click Rate\n";
                    report.sections.category_performance.categories.forEach(cat => {
                        csvContent += `${cat.name},${cat.count},${cat.avgScore},${cat.totalViews},${cat.clickRate}%\n`;
                    });
                    csvContent += "\n";
                }

                this.downloadFile(csvContent, `${report.config.name}.csv`, 'text/csv');
            }

            downloadCSV(report) {
                if (report.sections.raw_data) {
                    const headers = Object.keys(report.sections.raw_data.promotions[0]);
                    let csvContent = headers.join(',') + '\n';

                    report.sections.raw_data.promotions.forEach(promo => {
                        const row = headers.map(header => `"${promo[header]}"`).join(',');
                        csvContent += row + '\n';
                    });

                    this.downloadFile(csvContent, `${report.config.name}.csv`, 'text/csv');
                }
            }

            downloadJSON(report) {
                const jsonContent = JSON.stringify(report, null, 2);
                this.downloadFile(jsonContent, `${report.config.name}.json`, 'application/json');
            }

            downloadPowerPoint(report) {
                // Simplified PowerPoint export (HTML slides)
                let slides = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>${report.config.name} - Presentation</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 0; }
                            .slide { width: 100vw; height: 100vh; padding: 40px; box-sizing: border-box; display: none; }
                            .slide.active { display: block; }
                            .slide h1 { font-size: 3em; text-align: center; }
                            .slide h2 { font-size: 2em; margin-bottom: 30px; }
                            .nav { position: fixed; bottom: 20px; right: 20px; }
                            button { margin: 5px; padding: 10px; }
                        </style>
                    </head>
                    <body>
                        <div class="slide active">
                            <h1>${report.config.name}</h1>
                            <div style="text-align: center; margin-top: 100px;">
                                <p>Generated: ${new Date(report.timestamp).toLocaleString()}</p>
                            </div>
                        </div>
                `;

                Object.entries(report.sections).forEach(([key, section], index) => {
                    slides += `
                        <div class="slide">
                            <h2>${section.title}</h2>
                            <div class="slide-content">
                                ${this.renderSlideContent(section)}
                            </div>
                        </div>
                    `;
                });

                slides += `
                        <div class="nav">
                            <button onclick="prevSlide()">Previous</button>
                            <button onclick="nextSlide()">Next</button>
                        </div>
                        <script>
                            let currentSlide = 0;
                            const slides = document.querySelectorAll('.slide');

                            function showSlide(n) {
                                slides[currentSlide].classList.remove('active');
                                currentSlide = (n + slides.length) % slides.length;
                                slides[currentSlide].classList.add('active');
                            }

                            function nextSlide() { showSlide(currentSlide + 1); }
                            function prevSlide() { showSlide(currentSlide - 1); }

                            document.addEventListener('keydown', (e) => {
                                if (e.key === 'ArrowRight') nextSlide();
                                if (e.key === 'ArrowLeft') prevSlide();
                            });
                        </script>
                    </body>
                    </html>
                `;

                this.downloadFile(slides, `${report.config.name}_presentation.html`, 'text/html');
            }

            renderSlideContent(section) {
                // Simplified slide content
                switch (section.title) {
                    case 'Executive Summary':
                        return `
                            <div style="font-size: 1.5em; line-height: 2em;">
                                <p>üìä ${section.metrics.totalPromotions} Promotions Analyzed</p>
                                <p>‚≠ê Average Score: ${section.metrics.avgScore}</p>
                                <p>üëÜ Click Rate: ${section.metrics.clickRate}%</p>
                            </div>
                        `;
                    default:
                        return `<p style="font-size: 1.2em;">Content for ${section.title}</p>`;
                }
            }

            downloadFile(content, filename, mimeType) {
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            quickExport(exportType, format) {
                let data, filename;

                switch (exportType) {
                    case 'current_week':
                        data = this.data.promotions;
                        filename = 'current_week_data';
                        break;
                    case 'top_performers':
                        data = [...this.data.promotions].sort((a, b) => b.composite_score - a.composite_score).slice(0, 20);
                        filename = 'top_performers';
                        break;
                    case 'category_summary':
                        data = this.data.categories;
                        filename = 'category_summary';
                        break;
                    case 'position_heatmap':
                        // Generate position data
                        data = this.generatePositionHeatmapData();
                        filename = 'position_heatmap';
                        break;
                }

                switch (format) {
                    case 'csv':
                        this.exportToCSV(data, filename);
                        break;
                    case 'excel':
                        this.exportToCSV(data, filename); // Simplified
                        break;
                    case 'json':
                        this.exportToJSON(data, filename);
                        break;
                    case 'pdf':
                        this.exportToPDF(data, filename, exportType);
                        break;
                    case 'png':
                        this.exportToPNG(data, filename);
                        break;
                    case 'powerpoint':
                        this.exportToPowerPoint(data, filename, exportType);
                        break;
                }
            }

            exportToCSV(data, filename) {
                if (data.length === 0) return;

                const headers = Object.keys(data[0]);
                let csvContent = headers.join(',') + '\n';

                data.forEach(item => {
                    const row = headers.map(header => `"${item[header] || ''}"`).join(',');
                    csvContent += row + '\n';
                });

                this.downloadFile(csvContent, `${filename}.csv`, 'text/csv');
            }

            exportToJSON(data, filename) {
                const jsonContent = JSON.stringify(data, null, 2);
                this.downloadFile(jsonContent, `${filename}.json`, 'application/json');
            }

            exportToPDF(data, filename, type) {
                // Simplified PDF export
                let content = `<h1>${filename.replace(/_/g, ' ').toUpperCase()}</h1>`;

                if (Array.isArray(data) && data.length > 0) {
                    content += '<table border="1" style="width: 100%; border-collapse: collapse;">';
                    const headers = Object.keys(data[0]);
                    content += '<tr>' + headers.map(h => `<th style="padding: 8px;">${h}</th>`).join('') + '</tr>';

                    data.slice(0, 50).forEach(item => {
                        content += '<tr>' + headers.map(h => `<td style="padding: 8px;">${item[h] || ''}</td>`).join('') + '</tr>';
                    });
                    content += '</table>';
                }

                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html><head><title>${filename}</title></head>
                    <body style="font-family: Arial, sans-serif; margin: 20px;">
                        ${content}
                    </body></html>
                `);
                printWindow.document.close();
                setTimeout(() => printWindow.print(), 250);
            }

            generatePositionHeatmapData() {
                const positions = ['top-left', 'top-center', 'top-right', 'center-left', 'center', 'center-right', 'bottom-left', 'bottom-center', 'bottom-right'];
                return positions.map(pos => {
                    const promos = this.data.promotions.filter(p => p.position === pos);
                    const avgScore = promos.length > 0 ? promos.reduce((sum, p) => sum + p.composite_score, 0) / promos.length : 0;
                    return {
                        position: pos,
                        count: promos.length,
                        averageScore: Math.round(avgScore),
                        totalViews: promos.reduce((sum, p) => sum + p.card_in_view, 0),
                        totalClicks: promos.reduce((sum, p) => sum + p.card_clicks, 0)
                    };
                });
            }

            switchTab(tabName) {
                // Update tab buttons
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.tab === tabName);
                });

                // Update tab panels
                document.querySelectorAll('.tab-panel').forEach(panel => {
                    panel.classList.toggle('active', panel.dataset.tab === tabName);
                });
            }

            scheduleReport() {
                const template = document.getElementById('scheduleTemplate').value;
                const frequency = document.getElementById('scheduleFrequency').value;
                const email = document.getElementById('scheduleEmail').value;
                const day = document.getElementById('scheduleDay').value;

                if (!template || !email) {
                    alert('Please fill in all required fields');
                    return;
                }

                const schedule = {
                    id: 'schedule_' + Date.now(),
                    template: template,
                    frequency: frequency,
                    email: email,
                    day: day,
                    created: new Date().toISOString(),
                    active: true
                };

                this.scheduledReports.push(schedule);
                this.saveScheduledReports();
                this.populateScheduledReports();

                // Reset form
                document.querySelector('.schedule-form').reset();
                alert('Report scheduled successfully!');
            }

            populateRecentReports() {
                const container = document.getElementById('recentReportsList');
                if (this.savedReports.length === 0) {
                    container.innerHTML = '<p class="empty-state">No recent reports found</p>';
                    return;
                }

                container.innerHTML = this.savedReports.map(report => `
                    <div class="report-item">
                        <div class="report-info">
                            <h3>${report.name}</h3>
                            <div class="report-meta">
                                <span>Format: ${report.format.toUpperCase()}</span>
                                <span>Generated: ${new Date(report.generated).toLocaleDateString()}</span>
                            </div>
                        </div>
                        <div class="report-actions">
                            <button type="button" class="regenerate-btn" data-id="${report.id}">Regenerate</button>
                            <button type="button" class="delete-btn" data-id="${report.id}">Delete</button>
                        </div>
                    </div>
                `).join('');

                // Add event listeners
                container.querySelectorAll('.regenerate-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const reportId = e.target.dataset.id;
                        this.regenerateReport(reportId);
                    });
                });

                container.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const reportId = e.target.dataset.id;
                        this.deleteReport(reportId);
                    });
                });
            }

            populateTemplates() {
                const container = document.getElementById('templatesList');
                if (this.templates.length === 0) {
                    container.innerHTML = '<p class="empty-state">No saved templates found</p>';
                    return;
                }

                container.innerHTML = this.templates.map(template => `
                    <div class="template-item">
                        <div class="template-info">
                            <h3>${template.name}</h3>
                            <div class="template-meta">
                                <span>Type: ${template.config.type}</span>
                                <span>Created: ${new Date(template.created).toLocaleDateString()}</span>
                            </div>
                        </div>
                        <div class="template-actions">
                            <button type="button" class="use-template-btn" data-id="${template.id}">Use Template</button>
                            <button type="button" class="delete-template-btn" data-id="${template.id}">Delete</button>
                        </div>
                    </div>
                `).join('');

                // Add event listeners
                container.querySelectorAll('.use-template-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const templateId = e.target.dataset.id;
                        this.useTemplate(templateId);
                    });
                });

                container.querySelectorAll('.delete-template-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const templateId = e.target.dataset.id;
                        this.deleteTemplate(templateId);
                    });
                });
            }

            populateScheduledReports() {
                const container = document.getElementById('existingSchedulesList');
                if (this.scheduledReports.length === 0) {
                    container.innerHTML = '<p class="empty-state">No scheduled reports found</p>';
                    return;
                }

                container.innerHTML = this.scheduledReports.map(schedule => `
                    <div class="schedule-item">
                        <div class="schedule-info">
                            <h3>${schedule.template}</h3>
                            <div class="schedule-meta">
                                <span>Frequency: ${schedule.frequency}</span>
                                <span>Day: ${schedule.day}</span>
                                <span>Status: ${schedule.active ? 'Active' : 'Paused'}</span>
                            </div>
                        </div>
                        <div class="schedule-actions">
                            <button type="button" class="toggle-schedule-btn" data-id="${schedule.id}">
                                ${schedule.active ? 'Pause' : 'Resume'}
                            </button>
                            <button type="button" class="delete-schedule-btn" data-id="${schedule.id}">Delete</button>
                        </div>
                    </div>
                `).join('');

                // Add event listeners
                container.querySelectorAll('.toggle-schedule-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const scheduleId = e.target.dataset.id;
                        this.toggleSchedule(scheduleId);
                    });
                });

                container.querySelectorAll('.delete-schedule-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const scheduleId = e.target.dataset.id;
                        this.deleteSchedule(scheduleId);
                    });
                });
            }

            // Utility methods
            calculateAverage(data, field) {
                return data.reduce((sum, item) => sum + (item[field] || 0), 0) / data.length;
            }

            calculateSum(data, field) {
                return data.reduce((sum, item) => sum + (item[field] || 0), 0);
            }

            getTopInsight() {
                const topCategory = this.data.categories
                    .sort((a, b) => b.score - a.score)[0];
                return `Top performing category: ${topCategory.name} with ${topCategory.score} score`;
            }

            // Storage methods
            loadSavedReports() {
                return JSON.parse(localStorage.getItem('analytics_saved_reports') || '[]');
            }

            saveSavedReports() {
                localStorage.setItem('analytics_saved_reports', JSON.stringify(this.savedReports));
            }

            loadTemplates() {
                const defaultTemplates = [
                    {
                        id: 'weekly_executive',
                        name: 'Weekly Executive Summary',
                        config: {
                            type: 'executive',
                            sections: ['executive_summary', 'kpi_overview', 'top_performers'],
                            visualizations: ['charts'],
                            format: 'pdf'
                        },
                        created: new Date().toISOString()
                    }
                ];

                return JSON.parse(localStorage.getItem('analytics_templates') || JSON.stringify(defaultTemplates));
            }

            saveTemplates() {
                localStorage.setItem('analytics_templates', JSON.stringify(this.templates));
            }

            loadScheduledReports() {
                return JSON.parse(localStorage.getItem('analytics_scheduled_reports') || '[]');
            }

            saveScheduledReports() {
                localStorage.setItem('analytics_scheduled_reports', JSON.stringify(this.scheduledReports));
            }

            // Action methods
            regenerateReport(reportId) {
                const report = this.savedReports.find(r => r.id === reportId);
                if (report) {
                    const newReport = this.buildReport(report.config);
                    this.downloadReport(newReport, report.config.format);
                }
            }

            deleteReport(reportId) {
                if (confirm('Are you sure you want to delete this report?')) {
                    this.savedReports = this.savedReports.filter(r => r.id !== reportId);
                    this.saveSavedReports();
                    this.populateRecentReports();
                }
            }

            useTemplate(templateId) {
                const template = this.templates.find(t => t.id === templateId);
                if (template) {
                    // Populate form with template configuration
                    document.getElementById('reportName').value = template.name;
                    document.getElementById('reportType').value = template.config.type;
                    document.getElementById('reportFormat').value = template.config.format;

                    // Set sections
                    document.querySelectorAll('input[name="sections"]').forEach(cb => {
                        cb.checked = template.config.sections.includes(cb.value);
                    });

                    // Set visualizations
                    if (template.config.visualizations) {
                        document.querySelectorAll('input[name="visualizations"]').forEach(cb => {
                            cb.checked = template.config.visualizations.includes(cb.value);
                        });
                    }

                    // Switch to report builder
                    this.switchTab('recent');
                    alert('Template loaded successfully!');
                }
            }

            deleteTemplate(templateId) {
                if (confirm('Are you sure you want to delete this template?')) {
                    this.templates = this.templates.filter(t => t.id !== templateId);
                    this.saveTemplates();
                    this.populateTemplates();
                }
            }

            toggleSchedule(scheduleId) {
                const schedule = this.scheduledReports.find(s => s.id === scheduleId);
                if (schedule) {
                    schedule.active = !schedule.active;
                    this.saveScheduledReports();
                    this.populateScheduledReports();
                }
            }

            deleteSchedule(scheduleId) {
                if (confirm('Are you sure you want to delete this scheduled report?')) {
                    this.scheduledReports = this.scheduledReports.filter(s => s.id !== scheduleId);
                    this.saveScheduledReports();
                    this.populateScheduledReports();
                }
            }

            downloadCurrentReport() {
                if (this.currentReport) {
                    this.downloadReport(this.currentReport, this.currentReport.config.format);
                }
            }
        }

        // Initialize the reports controller when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new ReportsController();
        });
    </script>
</body>
</html>